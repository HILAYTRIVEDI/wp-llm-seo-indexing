#!/bin/bash
#
# Pre-commit hook for WP LLM SEO Indexing
# Prevents committing secrets and enforces code quality
#

set -e

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Secret Detection
echo "üîê Checking for secrets..."

SECRET_PATTERNS=(
    "api[_-]?key\s*=\s*['\"][a-zA-Z0-9_-]{20,}['\"]"
    "token\s*=\s*['\"][a-zA-Z0-9_-]{20,}['\"]"
    "password\s*=\s*['\"][^'\"]{8,}['\"]"
    "secret\s*=\s*['\"][a-zA-Z0-9_-]{20,}['\"]"
    "AIza[0-9A-Za-z\\-_]{35}"
    "sk-[a-zA-Z0-9]{48}"
    "sk-ant-[a-zA-Z0-9-]{95}"
    "PRIVATE KEY"
    "BEGIN RSA PRIVATE KEY"
)

SECRETS_FOUND=0

for pattern in "${SECRET_PATTERNS[@]}"; do
    if git diff --cached --diff-filter=ACM -U0 | grep -E "$pattern" > /dev/null 2>&1; then
        echo -e "${RED}‚ùå Potential secret detected: $pattern${NC}"
        SECRETS_FOUND=1
    fi
done

if [ $SECRETS_FOUND -eq 1 ]; then
    echo -e "${RED}‚ùå Commit aborted: Secrets detected in staged files${NC}"
    echo -e "${YELLOW}Please remove secrets and use environment variables instead${NC}"
    echo -e "${YELLOW}See SECURITY-REMEDIATION.md for guidance${NC}"
    exit 1
fi

echo -e "${GREEN}‚úì No secrets detected${NC}"

# PHP CodeSniffer (if available)
if command -v phpcs > /dev/null 2>&1; then
    echo "üîß Running PHPCS..."
    
    # Get list of staged PHP files
    PHP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.php$' || true)
    
    if [ -n "$PHP_FILES" ]; then
        if ! phpcs --standard=WordPress $PHP_FILES; then
            echo -e "${RED}‚ùå PHPCS failed. Please fix coding standards issues.${NC}"
            exit 1
        fi
        echo -e "${GREEN}‚úì PHPCS passed${NC}"
    fi
else
    echo -e "${YELLOW}‚ö† PHPCS not found, skipping${NC}"
fi

# ESLint (if available)
if command -v npx > /dev/null 2>&1 && [ -f "package.json" ]; then
    echo "üîß Running ESLint..."
    
    # Get list of staged JS files
    JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.js$' || true)
    
    if [ -n "$JS_FILES" ]; then
        if ! npx eslint $JS_FILES; then
            echo -e "${RED}‚ùå ESLint failed. Please fix JavaScript issues.${NC}"
            exit 1
        fi
        echo -e "${GREEN}‚úì ESLint passed${NC}"
    fi
else
    echo -e "${YELLOW}‚ö† ESLint not available, skipping${NC}"
fi

# Check for debugging statements
echo "üêõ Checking for debugging statements..."

DEBUG_PATTERNS=(
    "var_dump"
    "print_r"
    "console\.log"
    "debugger;"
    "error_log.*\\\$_POST"
    "error_log.*\\\$_GET"
)

DEBUG_FOUND=0

for pattern in "${DEBUG_PATTERNS[@]}"; do
    if git diff --cached --diff-filter=ACM | grep -E "$pattern" > /dev/null 2>&1; then
        echo -e "${YELLOW}‚ö† Debugging statement detected: $pattern${NC}"
        DEBUG_FOUND=1
    fi
done

if [ $DEBUG_FOUND -eq 1 ]; then
    echo -e "${YELLOW}‚ö† Warning: Debugging statements found. Consider removing before commit.${NC}"
    read -p "Continue anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Check for TODO/FIXME
echo "üìù Checking for TODO/FIXME comments..."

TODO_COUNT=$(git diff --cached --diff-filter=ACM | grep -E "TODO|FIXME" | wc -l || echo "0")

if [ "$TODO_COUNT" -gt 0 ]; then
    echo -e "${YELLOW}‚ö† Found $TODO_COUNT TODO/FIXME comments${NC}"
fi

# Final success message
echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
exit 0
